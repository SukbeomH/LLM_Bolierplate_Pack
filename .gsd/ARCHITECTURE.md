# Architecture

> Generated by /codebase-mapper on 2026-01-30

## Overview

AI 에이전트 기반 개발을 위한 경량 프로젝트 보일러플레이트. 코드베이스 자체가 아닌 **개발 워크플로우 인프라**를 제공한다. 실제 애플리케이션 코드는 사용자가 GSD 워크플로우를 통해 생성한다. **Multi-language Bootstrap**을 통해 Python, Node.js, Go, Rust 프로젝트를 자동 감지하고 환경을 구성한다.

핵심 구성: code-graph-rag(AST 분석, Tree-sitter + SQLite) + memory-graph(에이전트 기억, FalkorDBLite) + MCP(도구 통합) + GSD(문서 기반 방법론) + 멀티 에이전트(Claude, GitHub, Gemini) + Multi-language Bootstrap(Detect-Ask-Confirm)

## System Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                    Developer / User                         │
└──────────────┬──────────────────────┬───────────────────────┘
               │                      │
       ┌───────▼────────┐    ┌────────▼─────────┐
       │  Claude Code   │    │  GitHub Agent /   │
       │  (Orchestrator)│    │  Gemini           │
       └───────┬────────┘    └────────┬──────────┘
               │                      │
       ┌───────▼──────────────────────┘
       │  Sub-Agents (13)  <── .claude/agents/
       │  ┌─────────┬──────────┬─────────┐
       │  │ Opus(5) │Sonnet(4) │Haiku(4) │
       │  │planner  │executor  │clean    │
       │  │arch-rev │verifier  │commit   │
       │  │impact   │plan-chk  │create-pr│
       │  │pr-review│codebase  │ctx-mon  │
       │  │debugger │          │         │
       │  └────┬────┴────┬─────┴────┬────┘
       │       │ skills  │ inherit  │
       │  ┌────▼─────────▼──────────▼────┐
       │  │  Skills (16)  <── .claude/skills/
       │  │  Knowledge + Workflow defs   │
       │  └──────────────────────────────┘
       │
       ┌───────▼──────────────────────────────────┐
       │           GSD Methodology                │
       │  31 workflows → SPEC → PLAN → EXECUTE    │
       │  .agent/workflows/ + .claude/skills/      │
       └───────┬──────────────────────┬───────────┘
               │                      │
       ┌───────▼────────┐    ┌────────▼──────────┐
       │ code-graph-rag │    │   memory-graph    │
       │ MCP (stdio)    │    │   MCP (stdio)     │
       │ @er77/code-    │    │   store/recall    │
       │ graph-rag-mcp  │    │   memories        │
       │ (SQLite)       │    └──────────────────┘
       └────────────────┘
                               ┌──────────────────┐
                               │   Context7 MCP   │
                               │   (HTTP)          │
                               │   docs lookup     │
                               └──────────────────┘
```

## Components

### 1. GSD Workflow Engine
- **Purpose:** 문서 기반 개발 방법론 실행 (SPEC → PLAN → EXECUTE → VERIFY)
- **Location:** `.agent/workflows/` (31 .md files)
- **Subcomponents:**
  - 워크플로우 정의 (31개 슬래시 명령)
    - Core: map, plan, execute, verify, quick-check, debug
    - Project: new-project, new-milestone, help, handoff, web-search
    - Phase: add/remove/insert/discuss/research-phase, list-phase-assumptions
    - Milestone: new/audit/complete-milestone, plan-milestone-gaps
    - Dev: feature-dev, bug-fix
    - Navigation: progress, pause, resume, add-todo, check-todos, update, whats-new
  - 템플릿 라이브러리 (`.gsd/templates/`, 22개)
  - 예제 (`.gsd/examples/`, 3개)
  - 상태 문서 (`.gsd/STATE.md`, `JOURNAL.md`, `TODO.md`)

### 2. Claude Code Skills & Sub-Agents
- **Purpose:** AI 에이전트의 모듈형 능력 정의 + 모델별 서브에이전트 실행
- **Skills Location:** `.claude/skills/` (16 SKILL.md files, 9 Python scripts, 7 shell scripts)
- **Agents Location:** `.claude/agents/` (13 agent .md files)
- **Skill Categories:**
  - **Planning (2):** planner, plan-checker
  - **Execution (4):** executor, commit, create-pr, clean
  - **Verification (3):** verifier, empirical-validation, pr-review
  - **Analysis (5):** arch-review, impact-analysis, codebase-mapper, context-health-monitor, debugger
  - **Infrastructure (2):** bootstrap (Detect-Ask-Confirm 플로우), memory-protocol (mcp-memory-service 사용 규약)
- **Agent-Skill Relationship:** 각 에이전트는 `skills` 필드로 대응하는 스킬을 참조하여 지식을 상속받음. `empirical-validation` 스킬만 에이전트 없이 가이드라인으로 유지.
- **Model Distribution:**
  - **Opus (5):** planner, arch-review, impact-analysis, pr-review, debugger — 복잡한 추론, 아키텍처 분석, 멀티 관점 평가
  - **Sonnet (4):** executor, verifier, plan-checker, codebase-mapper — 멀티파일 구현, 검증, 탐색
  - **Haiku (4):** clean, commit, create-pr, context-health-monitor — 경량 도구 호출, 포매팅

### 3. Claude Code Hooks
- **Purpose:** Claude Code 도구 호출 전후 자동 실행되는 가드레일 및 자동화
- **Location:** `.claude/hooks/` (14 files: 2 Python, 12 Shell)
- **Hooks:**
  - `bash-guard.py` (PreToolUse:Bash) — 파괴적 git 명령 + pip/poetry 사용 차단
  - `file-protect.py` (PreToolUse:Edit|Write|Read) — .env, 시크릿, 인증서 파일 수정 차단
  - `auto-format.sh` (PostToolUse:Edit|Write) — Python 파일 수정 후 ruff format + check --fix 자동 실행
  - `session-start.sh` (SessionStart) — GSD STATE.md + git status를 additionalContext로 주입
  - `pre-compact-save.sh` (PreCompact) — STATE.md/JOURNAL.md 백업으로 컨텍스트 손실 방지
  - `post-turn-index.sh` (Stop) — 턴 종료 시 code-graph-rag 인덱스 갱신
  - `post-turn-verify.sh` (Stop) — 턴 종료 시 변경사항 검증
  - `stop-context-save.sh` (Stop) — 턴 종료 시 컨텍스트 저장
  - `save-session-changes.sh` (SessionEnd) — 세션 종료 시 변경사항 저장
  - `save-transcript.sh` (SessionEnd) — 세션 종료 시 트랜스크립트 저장
  - `mcp-store-memory.sh` — mcp-memory-service 기억 저장 헬퍼
  - `mcp-recall-memory.sh` — mcp-memory-service 기억 조회 헬퍼
  - `track-modifications.sh` (PostToolUse:Edit|Write|Bash) — 파일 수정 추적
  - `_json_parse.sh` — JSON 파싱 유틸리티 (공유 라이브러리)

### 4. code-graph-rag + memory-graph + MCP
- **Purpose:** AST 기반 코드 분석 및 에이전트 영구 기억 제공
- **Location:** `.mcp.json`
- **Components:**
  - code-graph-rag (stdio MCP 서버, `@er77/code-graph-rag-mcp`, Tree-sitter + SQLite, 19개 도구)
  - mcp-memory-service (stdio MCP 서버, doobidoo/mcp-memory-service, SQLite + semantic search, 8개 도구)
  - Context7 (HTTP MCP 서버, 라이브러리 문서 조회, 2개 도구)
  - Key Tools (graph-code): `query`, `semantic_search`, `analyze_code_impact`, `analyze_hotspots`, `detect_code_clones`, `list_file_entities`, `list_entity_relationships`, `index`, `clean_index`
  - Key Tools (memory): `memory_store`, `memory_search`, `memory_update`, `memory_delete`, `memory_stats`, `memory_list`, `memory_graph`, `memory_quality`
  - Key Tools (context7): `resolve-library-id`, `query-docs`

### 5. Infrastructure
- **Purpose:** 개발 환경 자동화
- **Location:** `Makefile` (15 targets), `scripts/` (10 files)
- **Services:**
  - code-graph-rag: `npx -y @er77/code-graph-rag-mcp` (on-demand, Docker 불필요)
  - Makefile 타겟: setup, install-deps, init-env, status, index, lint, lint-fix, fmt, test, typecheck, validate, patch-prompt, patch-restore, patch-clean, clean, help, check-deps, build, generate-claude-md
- **Scripts (`scripts/`):**
  - `bootstrap.sh` — 시스템 전제조건 검증 (tools, MCP, env)
  - `detect-language.sh` — 언어/패키지매니저/테스트러너 자동 감지 (Python, Node.js, Go, Rust)
  - `load-config.sh` — `project-config.yaml` YAML → 환경변수 로더
  - `generate-claude-md.sh` — CLAUDE.md 동적 생성
  - `build-plugin.sh` — gsd-plugin 빌드 (Claude Code 플러그인)
  - `build-antigravity.sh` — Antigravity IDE 워크스페이스 빌드
  - `build-opencode.sh` — OpenCode 워크스페이스 빌드
  - `compact-context.sh` — 컨텍스트 압축 (PATTERNS, JOURNAL, CHANGELOG)
  - `organize-docs.sh` — 문서 정리 (REPORT-*, RESEARCH-* 분류)
  - `convert-hooks-to-plugins.py` — Hook → Plugin 변환 유틸리티

### 6. Multi-Agent Configuration
- **Purpose:** 동일 GSD 방법론을 3+13 에이전트에서 사용
- **Orchestrator Agents:**
  - **Claude Code:** `.claude/skills/`, `.claude/agents/`, `CLAUDE.md`, `.claude/settings.json`
  - **GitHub Agent:** `.github/agents/agent.md` (Senior Staff Engineer role)
  - **Gemini:** `.gemini/GEMINI.md`
- **Claude Sub-Agents (13):** `.claude/agents/` — 태스크 유형별 모델이 지정된 서브에이전트

  | Agent | Model | Tools | Skill |
  |-------|-------|-------|-------|
  | planner | opus | Read, Grep, Glob | planner |
  | arch-review | opus | Read, Grep, Glob | arch-review |
  | impact-analysis | opus | Read, Grep, Glob | impact-analysis |
  | pr-review | opus | Read, Bash, Grep, Glob | pr-review |
  | debugger | opus | Read, Write, Edit, Bash, Grep, Glob | debugger |
  | executor | sonnet | Read, Write, Edit, Bash, Grep, Glob | executor |
  | verifier | sonnet | Read, Bash, Grep, Glob | verifier |
  | plan-checker | sonnet | Read, Grep, Glob | plan-checker |
  | codebase-mapper | sonnet | Read, Bash, Grep, Glob | codebase-mapper |
  | clean | haiku | Read, Write, Edit, Bash, Grep, Glob | clean |
  | commit | haiku | Read, Bash, Grep, Glob | commit |
  | create-pr | haiku | Read, Bash, Grep, Glob | create-pr |
  | context-health-monitor | haiku | Read, Grep, Glob | context-health-monitor |

### 7. Code Quality Gate
- **Purpose:** 코드 품질 자동 검증
- **Location:** `pyproject.toml`, `.vscode/`
- **Tools:**
  - Ruff (9종 규칙: E,F,I,N,W,B,C90,PL,TC / line-length=100 / McCabe<=10 / max-args=6)
  - Mypy (strict: warn_return_any, warn_unused_configs)
  - Pytest (testpaths=["tests"])
  - VS Code 워크스페이스 설정 (4개 확장 권장)
- **CI/CD:** `.github/workflows/ci.yml` (lint + typecheck + test, Python 3.11-3.13)

### 8. Testing Framework
- **Purpose:** 경험적 검증 기반 품질 보증
- **Location:** `tests/`
- **Structure:**
  - `conftest.py` — 3 fixtures: `db_conn` (in-memory SQLite), `project_root` (Path), `tmp_workspace` (tmp_path)
  - `test_sample.py` — 8 tests: TestProjectStructure (4), TestDatabaseFixture (2), TestTmpWorkspace (2)
- **Philosophy:** mock 최소화, 실제 객체 우선, 테스트별 격리, 외부 API만 mock

### 9. Utility: gsd-stat
- **Purpose:** 프로젝트 통계 분석 및 리포팅 (CLI)
- **Location:** `src/gsd_stat/`
- **Modules:**
  - `analyzer.py`: 파일 확장자별 라인 수, TODO/FIXME 마커 카운팅
  - `reporter.py`: 결과 포매팅 (Plain Text, JSON)
  - `cli.py`: CLI 진입점 및 인자 처리

### 10. Multi-language Bootstrap
- **Purpose:** 프로젝트 언어/환경 자동 감지 및 설정 (Detect-Ask-Confirm 플로우)
- **Location:** `scripts/detect-language.sh`, `scripts/load-config.sh`, `scripts/generate-claude-md.sh`, `.gsd/project-config.yaml`
- **Supported Languages:** Python, Node.js, Go, Rust
- **Detection Strategy:** `qlty.toml` → marker file fallback (`pyproject.toml`, `package.json`, `go.mod`, `Cargo.toml`)
- **Package Managers:**
  - Python: uv, poetry, pip
  - Node.js: npm, yarn, pnpm, bun
  - Go: go modules
  - Rust: cargo
- **Flow:**
  1. `detect-language.sh` — 프로젝트 루트 스캔, JSON 출력 `{language, variant, version, confidence}`
  2. `project-config.yaml` — 감지 결과 + 사용자 확인 저장
  3. `load-config.sh` — YAML → 환경변수 변환
  4. `generate-claude-md.sh` — `project-config.yaml` 기반 CLAUDE.md 동적 생성
- **Quality Gate Integration:** Qlty CLI (`qlty check`, `qlty fmt`) 또는 언어별 폴백 (Ruff, ESLint 등)
- **Configuration:** `.gsd/project-config.yaml` (언어, 패키지매니저, 테스트러너, 품질도구, 메모리 설정)

### 11. Reference Repositories (외부 참고)
- **Purpose:** Claude Code 생태계 레퍼런스 자료
- **Location:** `awesome-claude-code/`, `claude-code-tips/`, `everything-claude-code/`, `ralph/`
- **Note:** 보일러플레이트 코어가 아닌 참고 자료. `.gitignore`에 포함

## Data Flow

```
User Intent
  → /new-project → .gsd/SPEC.md (requirements lock)
  → /plan N      → Phase execution plan (XML tasks)
  → /execute N   → Source Code + atomic commits
  → /quick-check → Immediate validation (7-step)
  → /verify N    → Verification with empirical evidence
  → /commit      → Conventional emoji commits (logical split)
  → /create-pr   → GitHub Pull Request (structured body)
  → /pr-review   → 6-persona review (Dev, QA, Security, Arch, DevOps, UX)
```

## Integration Points

| External Service | Type | Purpose | Config |
|---|---|---|---|
| code-graph-rag | AST Analyzer (stdio, `@er77/code-graph-rag-mcp`, 19 tools) | 코드 분석 MCP 서버 (Tree-sitter + SQLite) | `.mcp.json` |
| memory-graph | Memory Store (stdio, FalkorDBLite, 12 tools) | 에이전트 영구 기억 MCP 서버 | `.mcp.json` |
| Context7 | Docs API (HTTP, 2 tools) | 라이브러리 문서 조회 | `.mcp.json` |
| GitHub | VCS + CI | 코드 호스팅, 이슈, PR, Actions | `.github/` |

## Conventions

- **Naming:** snake_case (Python), kebab-case (파일/디렉토리), `*Factory`/`Create*` 예외 허용
- **Structure:** `.gsd/`에 워킹 문서, `.gsd/templates/`에 템플릿, `.agent/workflows/`에 명령 정의
- **Testing:** `tests/` 디렉토리, pytest, mock 최소화 정책, 새 기능 = 새 테스트
- **Commits:** conventional commit + emoji, atomic commits per task
- **Package Manager:** uv only (pip/poetry 사용 금지)
- **Validation:** 경험적 증거 기반. 3회 연속 실패 시 접근 방식 변경
- **Hooks:** PreToolUse 가드(bash-guard, file-protect) + PostToolUse 자동포맷/추적 + SessionStart/PreCompact 상태 보존 + Stop 인덱스/검증/저장 + SessionEnd 트랜스크립트/변경사항 보존

## Technical Debt

### Resolved
- [x] `scripts/validate_spec.py` 경로 수정: `.agent/agent.md` → `.github/agents/agent.md`
- [x] `tests/` 스켈레톤 구성 완료: conftest.py (3 fixtures) + 29 tests (3 파일)
- [x] CI/CD 파이프라인 구성: `.github/workflows/ci.yml` (lint + typecheck + test, Python 3.12)
- [x] Reference repos `.gitignore`에 추가: `awesome-claude-code/`, `claude-code-tips/`, `everything-claude-code/`, `ralph/`
- [x] `.vscode/` 팀 공유 가능: settings.json + extensions.json 커밋
- [x] Docker/Memgraph 의존성 제거 — code-graph-rag SQLite 기반으로 전환
- [x] Python 버전 3.12 고정 — `pyproject.toml`, CI, Ruff, Mypy 모두 일치
- [x] `scripts/validate_spec.py` 참조 제거 — 파일 존재하지 않음
- [x] `python-snippets` 서브모듈 정리 — 디렉토리 및 설정 모두 제거됨
- [x] 예제 CLI 도구 추가 — `gsd-stat` (src/gsd_stat/, 29개 테스트)
- [x] gsd-plugin 전환 완료 — v1.2.0 배포, 31 commands, 16 skills, 13 agents
- [x] 컨텍스트 관리 시스템 — PATTERNS.md, compact-context.sh, organize-docs.sh, context-config.yaml, archive/

### Open — Medium Priority
- [ ] `compact-context.sh` 아카이브 로직 미구현 — TODO 주석만 존재, 실제 아카이빙 로직 구현 필요
- [ ] 보안 Hook 테스트 미작성 — `bash-guard.py`, `file-protect.py` (보안 크리티컬 가드레일, 수동 테스트만 수행 중)
- [ ] Shell 스크립트 shebang 비일관 — `#!/bin/bash` (일부 hooks) vs `#!/usr/bin/env bash` (대부분 scripts) 혼재. `#!/usr/bin/env bash`로 통일 권장

### Open — Low Priority
- [ ] Skill 헬퍼 스크립트 테스트 미작성 — `.claude/skills/*/scripts/` 내 Python 11개 파일 (`analyze_diff.py`, `find_circular_imports.py`, `detect_stubs.py`, `validate_plan.py`, `parse_plan.py` 등)
- [ ] `convert-hooks-to-plugins.py` TypeScript placeholder — `"// TODO: Adapt shell logic to TypeScript"` 주석만 존재
- [ ] MCP 서버 2개 외부 의존 — code-graph-rag (npx on-demand), mcp-memory-service (pipx) 별도 설치 필요 (설계 의도)
- [ ] `.gsd/SPEC.md`가 템플릿 상태 — 실제 프로젝트 스펙 미작성 (보일러플레이트 특성)
- [ ] 컨텍스트 관리 완성 — CURRENT.md, prd-active.json, prd-done.json 미구현
- [ ] Multi-language Bootstrap — Ruby, Java/Kotlin 등 추가 언어 지원 미구현
- [ ] Qlty CLI 통합 — `project-config.yaml`의 `qlty.enabled` 플래그 기반 조건부 활성화 (현재 disabled)
- [x] ~~memorygraph 쿼리 필터링~~ — mcp-memory-service 마이그레이션으로 해소 (프로젝트별 DB 파일 격리)

### Strengths (2026-01-30 감사 결과)
- hardcoded 경로/시크릿 없음 — 모든 경로 환경변수 간접 참조 (`CLAUDE_PROJECT_DIR`, `CLAUDE_PLUGIN_ROOT`)
- JSON/YAML 파싱 런타임 fallback 구성 — `_json_parse.sh` (`jq` → `python3` → `node`), `load-config.sh` (`yq` → `python3` → `grep`)
- deprecated 코드 없음 — 마이그레이션 필요 항목 없음
- 테스트 인프라 양호 — conftest.py (3 fixtures), `gsd_stat` 3개 테스트 파일 29개 테스트

> **상세 구현 현황**: `.gsd/reports/REPORT-implementation-status-2026-01.md` 참조
