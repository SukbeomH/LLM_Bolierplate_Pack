# Architecture

> Generated by /codebase-mapper on 2026-01-28

## Overview

AI 에이전트 기반 개발을 위한 경량 프로젝트 보일러플레이트. 코드베이스 자체가 아닌 **개발 워크플로우 인프라**를 제공한다. 실제 애플리케이션 코드는 사용자가 GSD 워크플로우를 통해 생성한다.

핵심 구성: code-graph-rag(AST 분석, Tree-sitter + SQLite) + memory-graph(에이전트 기억) + MCP(도구 통합) + GSD(문서 기반 방법론) + 멀티 에이전트(Claude, GitHub, Gemini)

## System Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                    Developer / User                         │
└──────────────┬──────────────────────┬───────────────────────┘
               │                      │
       ┌───────▼────────┐    ┌────────▼─────────┐
       │  Claude Code   │    │  GitHub Agent /   │
       │  (Orchestrator)│    │  Gemini           │
       └───────┬────────┘    └────────┬──────────┘
               │                      │
       ┌───────▼──────────────────────┘
       │  Sub-Agents (13)  <── .claude/agents/
       │  ┌─────────┬──────────┬─────────┐
       │  │ Opus(5) │Sonnet(4) │Haiku(4) │
       │  │planner  │executor  │clean    │
       │  │arch-rev │verifier  │commit   │
       │  │impact   │plan-chk  │create-pr│
       │  │pr-review│codebase  │ctx-mon  │
       │  │debugger │          │         │
       │  └────┬────┴────┬─────┴────┬────┘
       │       │ skills  │ inherit  │
       │  ┌────▼─────────▼──────────▼────┐
       │  │  Skills (14)  <── .claude/skills/
       │  │  Knowledge + Workflow defs   │
       │  └──────────────────────────────┘
       │
       ┌───────▼──────────────────────────────────┐
       │           GSD Methodology                │
       │  29 workflows → SPEC → PLAN → EXECUTE    │
       │  .agent/workflows/ + .claude/skills/      │
       └───────┬──────────────────────┬───────────┘
               │                      │
       ┌───────▼────────┐    ┌────────▼──────────┐
       │ code-graph-rag │    │   memory-graph    │
       │ MCP (stdio)    │    │   MCP (stdio)     │
       │ @er77/code-    │    │   store/recall    │
       │ graph-rag-mcp  │    │   memories        │
       │ (SQLite)       │    └──────────────────┘
       └────────────────┘
                               ┌──────────────────┐
                               │   Context7 MCP   │
                               │   (HTTP)          │
                               │   docs lookup     │
                               └──────────────────┘
```

## Components

### 1. GSD Workflow Engine
- **Purpose:** 문서 기반 개발 방법론 실행 (SPEC → PLAN → EXECUTE → VERIFY)
- **Location:** `.agent/workflows/` (29 .md files)
- **Subcomponents:**
  - 워크플로우 정의 (29개 슬래시 명령)
    - Core: map, plan, execute, verify, quick-check, debug
    - Project: new-project, new-milestone, help, handoff, web-search
    - Phase: add/remove/insert/discuss/research-phase, list-phase-assumptions
    - Milestone: new/audit/complete-milestone, plan-milestone-gaps
    - Dev: feature-dev, bug-fix
    - Navigation: progress, pause, resume, add-todo, check-todos, update, whats-new
  - 템플릿 라이브러리 (`.gsd/templates/`, 22개)
  - 예제 (`.gsd/examples/`, 3개)
  - 상태 문서 (`.gsd/STATE.md`, `JOURNAL.md`, `TODO.md`)

### 2. Claude Code Skills & Sub-Agents
- **Purpose:** AI 에이전트의 모듈형 능력 정의 + 모델별 서브에이전트 실행
- **Skills Location:** `.claude/skills/` (14 SKILL.md files, 9 Python scripts, 7 shell scripts)
- **Agents Location:** `.claude/agents/` (13 agent .md files)
- **Skill Categories:**
  - **Planning (2):** planner, plan-checker
  - **Execution (4):** executor, commit, create-pr, clean
  - **Verification (3):** verifier, empirical-validation, pr-review
  - **Analysis (5):** arch-review, impact-analysis, codebase-mapper, context-health-monitor, debugger
- **Agent-Skill Relationship:** 각 에이전트는 `skills` 필드로 대응하는 스킬을 참조하여 지식을 상속받음. `empirical-validation` 스킬만 에이전트 없이 가이드라인으로 유지.
- **Model Distribution:**
  - **Opus (5):** planner, arch-review, impact-analysis, pr-review, debugger — 복잡한 추론, 아키텍처 분석, 멀티 관점 평가
  - **Sonnet (4):** executor, verifier, plan-checker, codebase-mapper — 멀티파일 구현, 검증, 탐색
  - **Haiku (4):** clean, commit, create-pr, context-health-monitor — 경량 도구 호출, 포매팅

### 3. Claude Code Hooks
- **Purpose:** Claude Code 도구 호출 전후 자동 실행되는 가드레일 및 자동화
- **Location:** `.claude/hooks/` (5 files: 2 Python, 3 Shell)
- **Hooks:**
  - `bash-guard.py` (PreToolUse:Bash) — 파괴적 git 명령 + pip/poetry 사용 차단
  - `file-protect.py` (PreToolUse:Edit|Write) — .env, 시크릿, 인증서 파일 수정 차단
  - `auto-format-py.sh` (PostToolUse:Edit|Write) — Python 파일 수정 후 ruff format + check --fix 자동 실행
  - `session-start.sh` (SessionStart) — GSD STATE.md + git status를 additionalContext로 주입
  - `pre-compact-save.sh` (PreCompact) — STATE.md/JOURNAL.md 백업으로 컨텍스트 손실 방지

### 4. code-graph-rag + memory-graph + MCP
- **Purpose:** AST 기반 코드 분석 및 에이전트 영구 기억 제공
- **Location:** `.mcp.json`
- **Components:**
  - code-graph-rag (stdio MCP 서버, `@er77/code-graph-rag-mcp`, Tree-sitter + SQLite, 19개 도구)
  - memory-graph (stdio MCP 서버, 그래프 기반 영구 기억, 12개 도구)
  - Context7 (HTTP MCP 서버, 라이브러리 문서 조회, 2개 도구)
  - Key Tools (graph-code): `query`, `semantic_search`, `analyze_code_impact`, `analyze_hotspots`, `detect_code_clones`, `list_file_entities`, `list_entity_relationships`, `index`, `clean_index`
  - Key Tools (memorygraph): `store_memory`, `recall_memories`, `search_memories`, `get_memory`, `create_relationship`, `get_memory_statistics`
  - Key Tools (context7): `resolve-library-id`, `query-docs`

### 5. Infrastructure
- **Purpose:** 개발 환경 자동화
- **Location:** `Makefile` (15 targets)
- **Services:**
  - code-graph-rag: `npx -y @er77/code-graph-rag-mcp` (on-demand, Docker 불필요)
  - Makefile 타겟: setup, install-deps, install-memorygraph, init-env, status, index, lint, lint-fix, test, typecheck, patch-prompt, patch-restore, patch-clean, clean, help, check-deps

### 6. Multi-Agent Configuration
- **Purpose:** 동일 GSD 방법론을 3+13 에이전트에서 사용
- **Orchestrator Agents:**
  - **Claude Code:** `.claude/skills/`, `.claude/agents/`, `CLAUDE.md`, `.claude/settings.json`
  - **GitHub Agent:** `.github/agents/agent.md` (Senior Staff Engineer role)
  - **Gemini:** `.gemini/GEMINI.md`
- **Claude Sub-Agents (13):** `.claude/agents/` — 태스크 유형별 모델이 지정된 서브에이전트

  | Agent | Model | Tools | Skill |
  |-------|-------|-------|-------|
  | planner | opus | Read, Grep, Glob | planner |
  | arch-review | opus | Read, Grep, Glob | arch-review |
  | impact-analysis | opus | Read, Grep, Glob | impact-analysis |
  | pr-review | opus | Read, Bash, Grep, Glob | pr-review |
  | debugger | opus | Read, Write, Edit, Bash, Grep, Glob | debugger |
  | executor | sonnet | Read, Write, Edit, Bash, Grep, Glob | executor |
  | verifier | sonnet | Read, Bash, Grep, Glob | verifier |
  | plan-checker | sonnet | Read, Grep, Glob | plan-checker |
  | codebase-mapper | sonnet | Read, Bash, Grep, Glob | codebase-mapper |
  | clean | haiku | Read, Write, Edit, Bash, Grep, Glob | clean |
  | commit | haiku | Read, Bash, Grep, Glob | commit |
  | create-pr | haiku | Read, Bash, Grep, Glob | create-pr |
  | context-health-monitor | haiku | Read, Grep, Glob | context-health-monitor |

### 7. Code Quality Gate
- **Purpose:** 코드 품질 자동 검증
- **Location:** `pyproject.toml`, `.vscode/`
- **Tools:**
  - Ruff (9종 규칙: E,F,I,N,W,B,C90,PL,TC / line-length=100 / McCabe<=10 / max-args=6)
  - Mypy (strict: warn_return_any, warn_unused_configs)
  - Pytest (testpaths=["tests"])
  - VS Code 워크스페이스 설정 (4개 확장 권장)
- **CI/CD:** `.github/workflows/ci.yml` (lint + typecheck + test, Python 3.11-3.13)

### 8. Testing Framework
- **Purpose:** 경험적 검증 기반 품질 보증
- **Location:** `tests/`
- **Structure:**
  - `conftest.py` — 3 fixtures: `db_conn` (in-memory SQLite), `project_root` (Path), `tmp_workspace` (tmp_path)
  - `test_sample.py` — 8 tests: TestProjectStructure (4), TestDatabaseFixture (2), TestTmpWorkspace (2)
- **Philosophy:** mock 최소화, 실제 객체 우선, 테스트별 격리, 외부 API만 mock

### 9. Reference Repositories (외부 참고)
- **Purpose:** Claude Code 생태계 레퍼런스 자료
- **Location:** `awesome-claude-code/`, `claude-code-tips/`, `everything-claude-code/`, `ralph/`
- **Note:** 보일러플레이트 코어가 아닌 참고 자료. `.gitignore`에 포함

## Data Flow

```
User Intent
  → /new-project → .gsd/SPEC.md (requirements lock)
  → /plan N      → Phase execution plan (XML tasks)
  → /execute N   → Source Code + atomic commits
  → /quick-check → Immediate validation (7-step)
  → /verify N    → Verification with empirical evidence
  → /commit      → Conventional emoji commits (logical split)
  → /create-pr   → GitHub Pull Request (structured body)
  → /pr-review   → 6-persona review (Dev, QA, Security, Arch, DevOps, UX)
```

## Integration Points

| External Service | Type | Purpose | Config |
|---|---|---|---|
| code-graph-rag | AST Analyzer (stdio, `@er77/code-graph-rag-mcp`, 19 tools) | 코드 분석 MCP 서버 (Tree-sitter + SQLite) | `.mcp.json` |
| memory-graph | Memory Store (stdio, 12 tools) | 에이전트 영구 기억 MCP 서버 | `.mcp.json` |
| Context7 | Docs API (HTTP, 2 tools) | 라이브러리 문서 조회 | `.mcp.json` |
| GitHub | VCS + CI | 코드 호스팅, 이슈, PR, Actions | `.github/` |

## Conventions

- **Naming:** snake_case (Python), kebab-case (파일/디렉토리), `*Factory`/`Create*` 예외 허용
- **Structure:** `.gsd/`에 워킹 문서, `.gsd/templates/`에 템플릿, `.agent/workflows/`에 명령 정의
- **Testing:** `tests/` 디렉토리, pytest, mock 최소화 정책, 새 기능 = 새 테스트
- **Commits:** conventional commit + emoji, atomic commits per task
- **Package Manager:** uv only (pip/poetry 사용 금지)
- **Validation:** 경험적 증거 기반. 3회 연속 실패 시 접근 방식 변경
- **Hooks:** PreToolUse 가드(bash-guard, file-protect) + PostToolUse 자동포맷 + SessionStart/PreCompact 상태 보존

## Technical Debt

### Resolved
- [x] `scripts/validate_spec.py` 경로 수정: `.agent/agent.md` → `.github/agents/agent.md`
- [x] `tests/` 스켈레톤 구성 완료: conftest.py (3 fixtures) + 29 tests (3 파일)
- [x] CI/CD 파이프라인 구성: `.github/workflows/ci.yml` (lint + typecheck + test, Python 3.12)
- [x] Reference repos `.gitignore`에 추가: `awesome-claude-code/`, `claude-code-tips/`, `everything-claude-code/`, `ralph/`
- [x] `.vscode/` 팀 공유 가능: settings.json + extensions.json 커밋
- [x] Docker/Memgraph 의존성 제거 — code-graph-rag SQLite 기반으로 전환
- [x] Python 버전 3.12 고정 — `pyproject.toml`, CI, Ruff, Mypy 모두 일치
- [x] `scripts/validate_spec.py` 참조 제거 — 파일 존재하지 않음
- [x] `python-snippets` 서브모듈 정리 — 디렉토리 및 설정 모두 제거됨
- [x] 예제 CLI 도구 추가 — `gsd-stat` (src/gsd_stat/, 29개 테스트)
- [x] gsd-plugin 전환 완료 — v1.2.0 배포, 31 commands, 14 skills, 13 agents
- [x] 컨텍스트 관리 시스템 — PATTERNS.md, compact-context.sh, organize-docs.sh

### Open
- [ ] MCP 서버 2개 외부 의존 — code-graph-rag (npx on-demand), memorygraph (pipx) 별도 설치 필요 (설계 의도)
- [ ] `.gsd/SPEC.md`가 템플릿 상태 — 실제 프로젝트 스펙 미작성 (보일러플레이트 특성)
- [ ] 컨텍스트 관리 완성 — CURRENT.md, prd-active.json, archive/ 미구현

> **상세 구현 현황**: `.gsd/reports/REPORT-implementation-status-2026-01.md` 참조
