name: Verify on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  verify:
    name: Verify Code Quality and Git Conventions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 필요 (커밋 메시지 검증용)

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Install tools
        run: mise install

      - name: Verify branch naming convention
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Checking branch: $BRANCH_NAME"

          # 브랜치 접두어 확인 (feature/ 또는 hotfix/)
          if ! echo "$BRANCH_NAME" | grep -qE "^(feature|hotfix)/"; then
            echo "❌ Branch name must start with 'feature/' or 'hotfix/'"
            echo "   Current branch: $BRANCH_NAME"
            echo "   Expected format: feature/{issue_number}-{description} or hotfix/{issue_number}-{description}"
            exit 1
          fi

          # 이슈 번호 포함 여부 확인 (숫자 포함)
          if ! echo "$BRANCH_NAME" | grep -qE "[0-9]+"; then
            echo "❌ Branch name must include issue number"
            echo "   Current branch: $BRANCH_NAME"
            echo "   Expected format: feature/{issue_number}-{description} or hotfix/{issue_number}-{description}"
            exit 1
          fi

          echo "✅ Branch naming convention: OK"

      - name: Verify commit message format
        run: |
          # PR의 모든 커밋 메시지 확인
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%H|%s")

          if [ -z "$COMMITS" ]; then
            echo "⚠️  No commits found in PR"
            exit 0
          fi

          INVALID_COMMITS=0
          while IFS= read -r commit_line; do
            COMMIT_HASH=$(echo "$commit_line" | cut -d'|' -f1)
            COMMIT_MSG=$(echo "$commit_line" | cut -d'|' -f2-)

            # "Resolved" 철자 확인 (Resovled 금지)
            if echo "$COMMIT_MSG" | grep -qi "resovled"; then
              echo "❌ Commit $COMMIT_HASH: 'Resovled' is misspelled. Use 'Resolved'"
              INVALID_COMMITS=$((INVALID_COMMITS + 1))
              continue
            fi

            # 커밋 메시지 형식 확인: "Resolved #{issue_number} - {description}"
            if ! echo "$COMMIT_MSG" | grep -qE "^Resolved #([0-9]+) - .+"; then
              echo "❌ Commit $COMMIT_HASH: Invalid commit message format"
              echo "   Message: $COMMIT_MSG"
              echo "   Expected format: Resolved #{issue_number} - {description}"
              INVALID_COMMITS=$((INVALID_COMMITS + 1))
            fi
          done <<< "$COMMITS"

          if [ $INVALID_COMMITS -gt 0 ]; then
            echo ""
            echo "❌ Found $INVALID_COMMITS invalid commit(s)"
            exit 1
          fi

          echo "✅ Commit message format: OK"

      - name: Run verification
        run: mise run verify

      - name: Check verification result
        if: failure()
        run: |
          echo "❌ Verification failed. Please check the errors above."
          exit 1
