name: Release GSD Plugin

on:
  push:
    branches: [master]
    paths:
      # Source files (build outputs generated in CI)
      - '.claude/**'
      - '.agent/**'
      - 'scripts/build-*.sh'
      - 'CLAUDE.md'
      - 'release-please-config.json'
      - '.release-please-manifest.json'
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      # Try both component-based and path-based output keys
      release_created: ${{ steps.release.outputs['gsd-plugin--release_created'] || steps.release.outputs['.--release_created'] || steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs['gsd-plugin--tag_name'] || steps.release.outputs['.--tag_name'] || steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs['gsd-plugin--version'] || steps.release.outputs['.--version'] || steps.release.outputs.version }}
    steps:
      - name: Release Please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Debug outputs
        run: |
          echo "=== All outputs ==="
          echo '${{ toJSON(steps.release.outputs) }}'
          echo "=== Resolved ==="
          echo "release_created: ${{ steps.release.outputs['gsd-plugin--release_created'] || steps.release.outputs['.--release_created'] || steps.release.outputs.release_created }}"
          echo "tag_name: ${{ steps.release.outputs['gsd-plugin--tag_name'] || steps.release.outputs['.--tag_name'] || steps.release.outputs.tag_name }}"
          echo "version: ${{ steps.release.outputs['gsd-plugin--version'] || steps.release.outputs['.--version'] || steps.release.outputs.version }}"

  build-and-upload:
    needs: release-please
    if: |
      needs.release-please.outputs.release_created == 'true' ||
      github.event_name == 'release' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release-info
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            VERSION=$(echo "$TAG" | sed 's/gsd-plugin-v//')
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Get latest release tag
            TAG=$(gh release view --repo "${{ github.repository }}" --json tagName -q .tagName)
            VERSION=$(echo "$TAG" | sed 's/gsd-plugin-v//')
          else
            TAG="${{ needs.release-please.outputs.tag_name }}"
            VERSION="${{ needs.release-please.outputs.version }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Resolved: tag=$TAG version=$VERSION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.release-info.outputs.tag }}

      - name: Build artifacts
        run: make build

      - name: Create Plugin ZIP
        run: |
          cd gsd-plugin
          zip -r ../gsd-plugin-${{ steps.release-info.outputs.version }}.zip . \
            -x ".git/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".pytest_cache/*" \
            -x "node_modules/*" \
            -x ".env" \
            -x ".venv/*" \
            -x "*.log" \
            -x ".DS_Store"

      - name: Create Antigravity ZIP
        run: |
          cd antigravity-boilerplate
          zip -r ../antigravity-boilerplate-${{ steps.release-info.outputs.version }}.zip . \
            -x ".git/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".pytest_cache/*" \
            -x "node_modules/*" \
            -x ".env" \
            -x ".venv/*" \
            -x "*.log" \
            -x ".DS_Store"

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-info.outputs.tag }}
          files: |
            gsd-plugin-${{ steps.release-info.outputs.version }}.zip
            antigravity-boilerplate-${{ steps.release-info.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.release-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.release-info.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Assets**:" >> $GITHUB_STEP_SUMMARY
          echo "  - gsd-plugin-${{ steps.release-info.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "  - antigravity-boilerplate-${{ steps.release-info.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
