name: Release GSD Plugin

on:
  push:
    branches: [master]
    paths:
      - 'gsd-plugin/**'
      - 'release-please-config.json'
      - '.release-please-manifest.json'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      # Component-specific outputs (release-please v4 monorepo format)
      release_created: ${{ steps.release.outputs['gsd-plugin--release_created'] }}
      tag_name: ${{ steps.release.outputs['gsd-plugin--tag_name'] }}
      version: ${{ steps.release.outputs['gsd-plugin--version'] }}
    steps:
      - name: Release Please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Debug outputs
        run: |
          echo "release_created: ${{ steps.release.outputs['gsd-plugin--release_created'] }}"
          echo "tag_name: ${{ steps.release.outputs['gsd-plugin--tag_name'] }}"
          echo "version: ${{ steps.release.outputs['gsd-plugin--version'] }}"

  build-and-upload:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Create Plugin ZIP
        run: |
          cd gsd-plugin
          zip -r ../gsd-plugin-${{ needs.release-please.outputs.version }}.zip . \
            -x ".git/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".pytest_cache/*" \
            -x "node_modules/*" \
            -x ".env" \
            -x ".venv/*" \
            -x "*.log" \
            -x ".DS_Store"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: gsd-plugin-${{ needs.release-please.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.release-please.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Asset**: gsd-plugin-${{ needs.release-please.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
