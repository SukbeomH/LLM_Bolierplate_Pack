name: Sync CLAUDE.md Knowledge

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  sync-knowledge:
    name: Extract @.claude tags and update CLAUDE.md
    runs-on: ubuntu-latest
    # PR 코멘트에서만 실행
    if: github.event.issue.pull_request && contains(github.event.comment.body, '@.claude')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract @.claude content
        id: extract_claude
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"

          # @.claude 태그 뒤의 내용 추출
          # 여러 줄 지원: @.claude 다음 줄부터 다음 빈 줄까지 또는 끝까지
          EXTRACTED=$(echo "$COMMENT_BODY" | sed -n '/@\.claude/,/^$/p' | sed '1d' | sed '/^$/d')

          if [ -z "$EXTRACTED" ]; then
            # @.claude 태그만 있고 내용이 없는 경우, 다음 줄부터 끝까지 추출
            EXTRACTED=$(echo "$COMMENT_BODY" | sed -n '/@\.claude/,$p' | sed '1d')
          fi

          # 멀티라인 출력을 위해 heredoc 사용
          {
            echo 'content<<EOF'
            echo "$EXTRACTED"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          # 디버깅용 출력
          echo "Extracted content:"
          echo "$EXTRACTED"

      - name: Update CLAUDE.md
        run: |
          EXTRACTED_CONTENT="${{ steps.extract_claude.outputs.content }}"

          if [ -z "$EXTRACTED_CONTENT" ]; then
            echo "⚠️  No content extracted from @.claude tag"
            exit 0
          fi

          CLAUDE_FILE="CLAUDE.md"

          # Lessons Learned 섹션 찾기
          if ! grep -q "## Lessons Learned" "$CLAUDE_FILE"; then
            echo "Creating 'Lessons Learned' section..."
            echo "" >> "$CLAUDE_FILE"
            echo "## Lessons Learned" >> "$CLAUDE_FILE"
            echo "" >> "$CLAUDE_FILE"
          fi

          # PR 정보 추출
          PR_NUMBER="${{ github.event.issue.number }}"
          PR_AUTHOR="${{ github.event.comment.user.login }}"
          PR_URL="${{ github.event.issue.pull_request.html_url }}"
          DATE_STR=$(date -u +'%Y-%m-%d')

          # 임시 파일에 엔트리 작성 (YAML 파싱 오류 방지)
          ENTRY_FILE=$(mktemp)

          if [ -n "$PR_URL" ] && [ "$PR_URL" != "null" ] && [ "$PR_URL" != "" ]; then
            {
              echo "### $DATE_STR - [PR #$PR_NUMBER]($PR_URL) (@$PR_AUTHOR)"
              echo ""
              echo "$EXTRACTED_CONTENT"
              echo ""
              echo "---"
              echo ""
            } > "$ENTRY_FILE"
          else
            {
              echo "### $DATE_STR - PR #$PR_NUMBER (@$PR_AUTHOR)"
              echo ""
              echo "$EXTRACTED_CONTENT"
              echo ""
              echo "---"
              echo ""
            } > "$ENTRY_FILE"
          fi

          # Lessons Learned 섹션 뒤에 삽입
          awk -v entry_file="$ENTRY_FILE" '
            /^## Lessons Learned/ {
              print
              getline
              print
              while ((getline line < entry_file) > 0) {
                print line
              }
              close(entry_file)
              next
            }
            { print }
          ' "$CLAUDE_FILE" > "$CLAUDE_FILE.tmp" && mv "$CLAUDE_FILE.tmp" "$CLAUDE_FILE"

          # 임시 파일 정리
          rm -f "$ENTRY_FILE"

          echo "✅ Updated CLAUDE.md with new knowledge entry"

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CLAUDE.md

          # 변경사항이 있는지 확인
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "docs: Update CLAUDE.md with knowledge from PR #${{ github.event.issue.number }}"
          git push

      - name: Create comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const commentBody = '✅ CLAUDE.md has been updated with the knowledge from your comment.';

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            } catch (error) {
              console.error('Failed to create comment:', error);
              // 코멘트 생성 실패는 워크플로우 실패로 처리하지 않음
            }
