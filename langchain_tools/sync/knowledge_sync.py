"""CLAUDE.md ì§€ì‹ ë™ê¸°í™”."""

from __future__ import annotations

import re
from datetime import datetime
from pathlib import Path
from typing import Any


def extract_lessons_learned(content: str) -> list[dict[str, str]]:
    """CLAUDE.mdì—ì„œ Lessons Learned í•­ëª©ì„ ì¶”ì¶œí•©ë‹ˆë‹¤."""
    lessons: list[dict[str, str]] = []

    # Lessons Learned ì„¹ì…˜ ì°¾ê¸°
    pattern = r'####\s+\[(\d{4}-\d{2}-\d{2})\]\s+(.+?)(?=####|\Z)'
    matches = re.findall(pattern, content, re.DOTALL)

    for date, body in matches:
        lessons.append({
            "date": date,
            "content": body.strip(),
        })

    return lessons


def merge_lessons(
    source_lessons: list[dict[str, str]],
    dest_lessons: list[dict[str, str]],
) -> list[dict[str, str]]:
    """ë‘ í”„ë¡œì íŠ¸ì˜ Lessons Learnedë¥¼ ë³‘í•©í•©ë‹ˆë‹¤."""
    # ë‚ ì§œ+ë‚´ìš© í•´ì‹œë¡œ ì¤‘ë³µ ê°ì§€
    seen = set()
    merged: list[dict[str, str]] = []

    for lesson in dest_lessons + source_lessons:
        key = f"{lesson['date']}:{lesson['content'][:100]}"
        if key not in seen:
            seen.add(key)
            merged.append(lesson)

    # ë‚ ì§œ ì—­ìˆœ ì •ë ¬
    merged.sort(key=lambda x: x["date"], reverse=True)

    return merged


def format_lessons(lessons: list[dict[str, str]]) -> str:
    """Lessons Learnedë¥¼ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ í¬ë§·í•©ë‹ˆë‹¤."""
    lines: list[str] = []

    for lesson in lessons:
        lines.append(f"#### [{lesson['date']}] ë™ê¸°í™”ëœ ì§€ì‹")
        lines.append("")
        lines.append(lesson["content"])
        lines.append("")

    return "\n".join(lines)


def sync_knowledge(
    source: Path,
    destination: Path,
    *,
    dry_run: bool = False,
) -> dict[str, Any]:
    """ì†ŒìŠ¤ í”„ë¡œì íŠ¸ì˜ CLAUDE.md ì§€ì‹ì„ ëŒ€ìƒ í”„ë¡œì íŠ¸ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.

    Args:
        source: ì†ŒìŠ¤ í”„ë¡œì íŠ¸ ê²½ë¡œ
        destination: ëŒ€ìƒ í”„ë¡œì íŠ¸ ê²½ë¡œ
        dry_run: Trueë©´ ì‹¤ì œ ë³€ê²½ ì—†ì´ ë¯¸ë¦¬ë³´ê¸°ë§Œ

    Returns:
        ë™ê¸°í™” ê²°ê³¼ ë”•ì…”ë„ˆë¦¬
    """
    result: dict[str, Any] = {
        "status": "success",
        "synced_count": 0,
        "message": "",
    }

    source_claude = source / "CLAUDE.md"
    dest_claude = destination / "CLAUDE.md"

    # íŒŒì¼ ì¡´ì¬ í™•ì¸
    if not source_claude.exists():
        result["status"] = "failed"
        result["message"] = f"ì†ŒìŠ¤ CLAUDE.mdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {source_claude}"
        return result

    if not dest_claude.exists():
        result["status"] = "failed"
        result["message"] = f"ëŒ€ìƒ CLAUDE.mdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {dest_claude}"
        return result

    try:
        source_content = source_claude.read_text(encoding="utf-8")
        dest_content = dest_claude.read_text(encoding="utf-8")

        # Lessons Learned ì¶”ì¶œ
        source_lessons = extract_lessons_learned(source_content)
        dest_lessons = extract_lessons_learned(dest_content)

        if not source_lessons:
            result["message"] = "ì†ŒìŠ¤ì— ë™ê¸°í™”í•  Lessons Learnedê°€ ì—†ìŠµë‹ˆë‹¤"
            return result

        # ë³‘í•©
        merged = merge_lessons(source_lessons, dest_lessons)
        new_count = len(merged) - len(dest_lessons)

        if new_count <= 0:
            result["message"] = "ë™ê¸°í™”í•  ìƒˆë¡œìš´ Lessons Learnedê°€ ì—†ìŠµë‹ˆë‹¤"
            return result

        # Lessons Learned ì„¹ì…˜ êµì²´
        lessons_section = format_lessons(merged)

        # ê¸°ì¡´ Lessons Learned ì„¹ì…˜ ì°¾ì•„ì„œ êµì²´
        pattern = r'(### ğŸ“š Lessons Learned.*?\n\n).*?(?=\n## |\Z)'
        replacement = f"\\1{lessons_section}"

        if re.search(pattern, dest_content, re.DOTALL):
            new_content = re.sub(pattern, replacement, dest_content, flags=re.DOTALL)
        else:
            # ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ëì— ì¶”ê°€
            new_content = dest_content + f"\n\n### ğŸ“š Lessons Learned\n\n{lessons_section}"

        if not dry_run:
            dest_claude.write_text(new_content, encoding="utf-8")

        result["synced_count"] = new_count
        result["message"] = f"{new_count}ê°œì˜ ìƒˆë¡œìš´ Lessons Learned ë™ê¸°í™”ë¨"

    except Exception as e:
        result["status"] = "failed"
        result["message"] = str(e)

    return result
